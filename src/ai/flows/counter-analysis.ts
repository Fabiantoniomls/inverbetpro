'use server';

/**
 * @fileOverview Implements the counter-analysis flow.
 * 
 * This flow takes an existing analysis and a new, external analysis, 
 * and provides a synthesized critique and second opinion from the perspective 
 * of a different AI persona, "iaedge".
 * 
 * - counterAnalysis - The main function for the flow.
 */

import { ai } from '@/ai/genkit';
import { z } from 'genkit';

const CounterAnalysisInputSchema = z.object({
    originalAnalysis: z.string().describe("The original analysis markdown text generated by 'Inverapuestas Pro'."),
    externalAnalysis: z.string().describe("A new analysis from an external source, provided by the user."),
});
export type CounterAnalysisInput = z.infer<typeof CounterAnalysisInputSchema>;

const CounterAnalysisOutputSchema = z.object({
    counterAnalysis: z.string().describe("The synthesized counter-analysis markdown text generated by 'iaedge'."),
});
export type CounterAnalysisOutput = z.infer<typeof CounterAnalysisOutputSchema>;


export async function counterAnalysis(input: CounterAnalysisInput): Promise<CounterAnalysisOutput> {
  return counterAnalysisFlow(input);
}


const counterAnalysisPrompt = ai.definePrompt({
  name: 'counterAnalysisPrompt',
  input: { schema: CounterAnalysisInputSchema },
  output: { schema: CounterAnalysisOutputSchema },
  prompt: `춰Hola! Soy **iaedge** 游뱄, tu especialista en s칤ntesis y an치lisis cr칤tico de apuestas. Mi trabajo es fusionar diferentes perspectivas para darte la visi칩n m치s completa.

He recibido dos an치lisis sobre un cup칩n de apuestas:
1.  **An치lisis Original (de "Inverapuestas Pro")**
2.  **An치lisis Externo (proporcionado por ti)**

**Tu Misi칩n:**
Act칰a como "iaedge" y genera un 칰nico informe en formato Markdown y en espa침ol que **sintetice, compare y contraste** ambos an치lisis. No critiques por criticar; tu objetivo es **extraer el m치ximo valor de ambas fuentes**.

**Estructura OBLIGATORIA de tu informe:**

1.  **S칤ntesis General:**
    *   Comienza con un p치rrafo resumen. 쯉on los an치lisis mayormente convergentes o divergentes? 쯈u칠 nuevas perspectivas aporta el an치lisis externo?

2.  **An치lisis Comparativo por Partido:**
    *   Para cada partido presente en el an치lisis original, comp치ralo con la visi칩n del an치lisis externo si tambi칠n lo cubre.
    *   Usa emojis para se침alar el grado de acuerdo:
        *   游뱋 **Convergencia:** Ambos an치lisis llegan a una conclusi칩n similar (ej. ambos ven valor en la misma selecci칩n).
        *   游뱂 **Divergencia/Matiz:** Uno de los an치lisis ofrece un punto de vista diferente, un dato clave que el otro omiti칩, o llega a una conclusi칩n de valor opuesta. Explica el porqu칠 de la diferencia.
        *   游 **Nueva Perspectiva:** El an치lisis externo aporta un dato completamente nuevo (ej. una lesi칩n de 칰ltima hora, una estad칤stica H2H relevante que no se consider칩).

3.  **Partidos Nuevos (si los hay):**
    *   Si el an치lisis externo incluye partidos que no estaban en el cup칩n original, anal칤zalos brevemente bajo el t칤tulo "Partidos Adicionales del An치lisis Externo".

4.  **Tabla de Valor Consolidada:**
    *   Crea una **칰nica** "TABLA DE APUESTAS DE VALOR" en Markdown.
    *   **CR칈TICO:** Incluye **SOLAMENTE** las selecciones donde **AMBOS** an치lisis (o la s칤ntesis final de "iaedge") coinciden en que hay valor positivo (EV > 0). Si solo uno lo ve, no lo incluyas. S칠 conservador.
    *   **CR칈TICO:** Ordena la tabla de MAYOR a MENOR "Valor Calculado", usando los datos del an치lisis original o un promedio si tiene sentido.

5.  **Conclusi칩n y Veredicto de "iaedge":**
    *   Finaliza con 2-3 puntos clave. 쯈u칠 an치lisis parece m치s robusto? 쯃a informaci칩n externa cambia la estrategia de apuestas recomendada? 쮺u치l es tu recomendaci칩n final como "iaedge"?

**An치lisis Original (de Inverapuestas Pro):**
\`\`\`markdown
{{{originalAnalysis}}}
\`\`\`

**An치lisis Externo (proporcionado por el usuario):**
\`\`\`markdown
{{{externalAnalysis}}}
\`\`\`

Ahora, genera el informe de s칤ntesis y contra-an치lisis completo como "iaedge". S칠 riguroso, objetivo y aporta claridad.`,
    config: {
      temperature: 0.2
    }
});


const counterAnalysisFlow = ai.defineFlow(
  {
    name: 'counterAnalysisFlow',
    inputSchema: CounterAnalysisInputSchema,
    outputSchema: CounterAnalysisOutputSchema,
  },
  async (input) => {
    const { output } = await counterAnalysisPrompt(input);
    if (!output) {
      throw new Error("No se pudo generar el contra-an치lisis.");
    }
    return { counterAnalysis: output.counterAnalysis };
  }
);
