'use server';

/**
 * @fileOverview Implements the counter-analysis flow.
 * 
 * This flow takes an existing analysis and provides a critique and a second opinion
 * from the perspective of a different AI persona, "iaedge".
 * 
 * - counterAnalysis - The main function for the flow.
 */

import { ai } from '@/ai/genkit';
import { z } from 'genkit';

const CounterAnalysisInputSchema = z.object({
    originalAnalysis: z.string().describe("The original analysis markdown text generated by 'Inverapuestas Pro'."),
});
export type CounterAnalysisInput = z.infer<typeof CounterAnalysisInputSchema>;

const CounterAnalysisOutputSchema = z.object({
    counterAnalysis: z.string().describe("The counter-analysis markdown text generated by 'iaedge'."),
});
export type CounterAnalysisOutput = z.infer<typeof CounterAnalysisOutputSchema>;


export async function counterAnalysis(input: CounterAnalysisInput): Promise<CounterAnalysisOutput> {
  return counterAnalysisFlow(input);
}


const counterAnalysisPrompt = ai.definePrompt({
  name: 'counterAnalysisPrompt',
  input: { schema: CounterAnalysisInputSchema },
  output: { schema: CounterAnalysisOutputSchema },
  prompt: `춰Hola! Soy **iaedge**, tu analista de apuestas deportivas de confianza 游늵. He procesado el an치lisis de "Inverapuestas Pro" y lo contrastar칠 con un marco cuantitativo y directrices m치s rigurosas.

Tu tarea es analizar el siguiente texto de an치lisis, identificar sus puntos fuertes y, m치s importante, sus 치reas de mejora fundamentales. Genera un contra-an치lisis en formato Markdown y en espa침ol.

**Marco de "iaedge" para el Contra-An치lisis:**

1.  **An치lisis Comparativo:**
    *   **Puntos Fuertes:** Identifica aspectos positivos del an치lisis original (ej. tono, c치lculo correcto del valor).
    *   **츼reas de Mejora Fundamentales:** Critica la falta de profundidad. La "Probabilidad real estimada" no debe ser una caja negra; debe justificarse con datos (H2H, rendimiento en la superficie espec칤fica, estad칤sticas clave como % de servicio, puntos de break salvados, etc.). El an치lisis original a menudo omite la superficie, lo cual es un fallo cr칤tico.

2.  **Cumplimiento de la Estructura Priorizada:**
    *   Verifica si la "TABLA DE APUESTAS DE VALOR" est치 **estrictamente ordenada de mayor a menor "Valor Calculado"**. Si no lo est치, se침치lalo como un error estrat칠gico y presenta la tabla correctamente ordenada en tu respuesta. Este orden es crucial para guiar al usuario a las oportunidades m치s rentables.

3.  **An치lisis Superficial vs. S칤ntesis Hol칤stica:**
    *   Critica las afirmaciones vagas como "estado de forma s칩lido" si no est치n respaldadas por datos concretos. Tu an치lisis debe ser una s칤ntesis hol칤stica de datos dispares para construir un modelo de probabilidad m치s robusto.

4.  **Conclusi칩n Final:**
    *   Resume por qu칠 tu enfoque es superior, destacando que la verdadera ventaja a largo plazo no proviene solo de encontrar valor, sino de **saber por qu칠 es valor**.

**Texto del An치lisis Original a Criticar:**
\`\`\`markdown
{{{originalAnalysis}}}
\`\`\`

Ahora, genera el contra-an치lisis completo como "iaedge", siguiendo la estructura y el tono del ejemplo proporcionado. Aseg칰rate de incluir la tabla de valor corregida y correctamente ordenada si es necesario.`,
});


const counterAnalysisFlow = ai.defineFlow(
  {
    name: 'counterAnalysisFlow',
    inputSchema: CounterAnalysisInputSchema,
    outputSchema: CounterAnalysisOutputSchema,
  },
  async (input) => {
    const { output } = await counterAnalysisPrompt(input);
    if (!output) {
      throw new Error("No se pudo generar el contra-an치lisis.");
    }
    return { counterAnalysis: output.counterAnalysis };
  }
);
