'use server';

/**
 * @fileOverview Implements the counter-analysis flow.
 * 
 * This flow takes a structured deconstruction of an original analysis and an external analysis,
 * and provides a synthesized critique and second opinion from the perspective 
 * of a different AI persona, "iaedge".
 * 
 * - counterAnalysis - The main function for the flow.
 */

import { ai } from '@/ai/genkit';
import { z } from 'genkit';
import { DeconstructedAnalysisSchema } from '@/lib/types/analysis';

const CounterAnalysisInputSchema = z.object({
    inverapuestasAnalysis: DeconstructedAnalysisSchema,
    externalAnalysis: DeconstructedAnalysisSchema,
});
export type CounterAnalysisInput = z.infer<typeof CounterAnalysisInputSchema>;

const CounterAnalysisOutputSchema = z.object({
    counterAnalysis: z.string().describe("The synthesized counter-analysis markdown text generated by 'iaedge'."),
});
export type CounterAnalysisOutput = z.infer<typeof CounterAnalysisOutputSchema>;


export async function counterAnalysis(input: CounterAnalysisInput): Promise<CounterAnalysisOutput> {
  return counterAnalysisFlow(input);
}


const counterAnalysisPrompt = ai.definePrompt({
  name: 'counterAnalysisPrompt',
  input: { schema: CounterAnalysisInputSchema },
  output: { schema: CounterAnalysisOutputSchema },
  prompt: `Eres "iaedge" ü§ñ, un analista comparativo de √©lite especializado en fusionar m√∫ltiples perspectivas de inversi√≥n deportiva. Se te han proporcionado dos an√°lisis ya deconstruidos en su estructura l√≥gica.

**Tu Misi√≥n:**
Genera un informe de s√≠ntesis comparativa en espa√±ol y formato Markdown. Tu informe debe mapear las relaciones l√≥gicas entre los dos an√°lisis y ofrecer una conclusi√≥n sintetizada. Utiliza esta estructura OBLIGATORIA:

1.  **Veredicto General:**
    *   Comienza con un p√°rrafo conciso. ¬øLas conclusiones principales coinciden o chocan? ¬øQu√© an√°lisis parece m√°s robusto y por qu√©?

2.  **Mapeo de Relaciones L√≥gicas:**
    *   **Puntos de Acuerdo (ü§ù):** Lista los argumentos o conclusiones en los que ambos an√°lisis est√°n de acuerdo.
    *   **Puntos de Divergencia (ü§î):** Describe los puntos clave de conflicto, explicando la diferencia en el razonamiento.
    *   **Argumentos √önicos de Inverapuestas Pro (üí°):** Lista los puntos clave que solo el an√°lisis original mencion√≥.
    *   **Argumentos √önicos del An√°lisis Externo (üÜï):** Lista los puntos clave que solo el an√°lisis externo aport√≥.

3.  **Tabla de Valor Consolidada:**
    *   Crea una **√∫nica** "TABLA DE APUESTAS DE VALOR" en Markdown.
    *   **CR√çTICO:** Incluye **SOLAMENTE** las selecciones donde, tras tu an√°lisis comparativo, sigues viendo un consenso o una fuerte evidencia de valor positivo (EV > 0). S√© conservador.

4.  **Conclusi√≥n Final de "iaedge":**
    *   Finaliza con tu recomendaci√≥n experta. ¬øQu√© acci√≥n sugieres? ¬øSe deber√≠a mantener la apuesta original, modificarla, o quiz√°s no hacer nada? Justifica tu veredicto final.

**Datos de los An√°lisis Deconstruidos:**
\`\`\`json
{{{jsonStringify this}}}
\`\`\`

Ahora, genera el informe de s√≠ntesis comparativa como "iaedge".`,
    config: {
      temperature: 0.2
    }
});


const counterAnalysisFlow = ai.defineFlow(
  {
    name: 'counterAnalysisFlow',
    inputSchema: CounterAnalysisInputSchema,
    outputSchema: CounterAnalysisOutputSchema,
  },
  async (input) => {
    const { output } = await counterAnalysisPrompt(input);
    if (!output) {
      throw new Error("No se pudo generar el contra-an√°lisis.");
    }
    return { counterAnalysis: output.counterAnalysis };
  }
);
